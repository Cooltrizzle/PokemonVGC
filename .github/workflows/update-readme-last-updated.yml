name: Update README last updated

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set timestamp (UTC)
        run: echo "TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      - name: Replace placeholder in README (robust)
        run: |
          set -eo pipefail
          FILE=README.md
          START='<!-- LAST_UPDATED:START -->'
          END='<!-- LAST_UPDATED:END -->'
          NEWLINE="Last updated: $TIMESTAMP"

          if [ ! -f "$FILE" ]; then
            echo "$FILE not found, creating minimal README with markers"
            cat > "$FILE" <<EOF
# Project Title

$START
$END
EOF
          fi

          echo "Before replacement (first 20 lines):"
          head -n 20 "$FILE" || true

          # Use perl to replace everything between markers (handles CRLFs safely)
          perl -0777 -pe '
            use File::Slurp;
            my $s = quotemeta("'"$START"'");
            my $e = quotemeta("'"$END"'");
            s/($s).*?($e)/$1\n'"$NEWLINE"'\n$2/sg;
          ' -- "$FILE" > "$FILE.tmp"
          mv "$FILE.tmp" "$FILE"

          echo "After replacement (first 20 lines):"
          head -n 20 "$FILE" || true

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FILE"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(readme): update last updated timestamp"
            git push origin HEAD:main
          fi
